{"version":3,"sources":["../src/ez-build-bin.js"],"names":[],"mappings":"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","file":"ez-build-bin.js","sourcesContent":["import program from 'commander'\nimport readPkg from 'read-package-json'\nimport { sync as find } from 'glob'\nimport { find as resolvePkg } from 'pkginfo'\nimport { dirname, relative, basename, resolve, normalize, delimiter } from 'path'\nimport { execSync as exec } from 'child_process'\nimport { optimize } from 'requirejs'\nimport { writeFileSync as put } from 'fs'\n\nconst pkgFile = resolvePkg(module, process.cwd())\n    , pkgRoot = dirname(pkgFile)\n    , pkgPath = relative.bind(null, pkgRoot)\n\nreadPkg(pkgFile, (err, pkg) => {\n  if (err) {\n    console.error(err.message)\n    process.exit(1)\n  }\n\n  pkg.directories || (pkg.directories = {})\n\n  const defaults =\n    { out: pkgPath(pkg.name + '-min.js')\n    , lib: pkgPath(pkg.directories.lib || 'lib')\n    , src: pkgPath(pkg.directories.src || 'src')\n    , jsc: 'babel'\n    , jscFlag:\n      { presets: ['es2015']\n      , plugins: ['transform-es2015-modules-amd']\n      }\n    , include: ['**/*.js']\n    , exclude: []\n    , optimize: 0\n    }\n\n  const cli = program\n    .version(require('../package.json').version)\n    .option('-i, --src <dir>', `the root directory from which all sources are relative [${defaults.src}]`, pkgPath, defaults.src)\n    .option('-o, --out <file>', `write optimized output to the specified file [${defaults.out}]`, pkgPath, defaults.out)\n    .option('-L, --lib <dir>', `write unoptimized files to the specified directory [${defaults.lib}]`, pkgPath, defaults.lib)\n    .option('-O, --optimize <level>', `specifies optimization level (0|1) [${defaults.optimize}]`, setOptimization, defaults.optimize)\n    .option('-I, --include <path>', `include the specified path or glob (relative to source root) [${defaults.include}]`, addPath.bind(null, defaults.include), defaults.include)\n    .option('-X, --exclude <path>', 'exclude the specified path or glob (relative to source root)', addPath.bind(null, defaults.exclude), defaults.exclude)\n    .option('--jsc <compiler>', `specifies the JS compiler command to be invoked [${defaults.jsc}]`, String, defaults.jsc)\n    .option('--jsc-flag <flag>=<value>', `specifies compiler flags; use += for additive behavior [${formatCCArgs(defaults.jscFlag)}]`, setFlag.bind(null, defaults.jscFlag), defaults.jscFlag)\n\n  const opts = cli.parse(process.argv)\n\n  setFlag(opts.jscFlag,\n    { 'source-maps' : true\n    , 'module-ids'  : true\n    , 'module-root' : `${pkg.name}/${opts.lib}`\n    , 'source-root' : opts.src\n    }\n  )\n\n  opts.include.length > 0 && setFlag(opts.jscFlag, { only: opts.include })\n  opts.exclude.length > 0 && setFlag(opts.jscFlag, { ignore: opts.exclude})\n\n  const jscArgs = Object.keys(opts.jscFlag).map(name => {\n    let pre = /^-|--/.test(name)? '' : '--'\n      , val = `=${opts.jscFlag[name]}`\n\n    if (typeof opts.jscFlag[name] === 'boolean') {\n      opts.jscFlag[name]? (val = '') : (pre = `${pre}no-`)\n    }\n\n    return `${pre}${name}${val}`\n  })\n\n  const cmd  = `${opts.jsc} ${opts.src} ${getTarget(opts)} ${formatCCArgs(opts.jscFlag)}`\n      , PATH = `${normalize('node_modules/.bin')}${delimiter}${process.env.PATH}`\n\n  log(cmd)\n\n  log()\n\n  exec(cmd,\n    { cwd: pkgRoot\n    , stdio: 'inherit'\n    , env: { PATH }\n    }\n  )\n\n  if (opts.optimize > 0) {\n    const modules = opts.include.reduce((list, pattern) => {\n      return list.concat(\n        find(`${opts.src}/${pattern}`).map(f => {\n          const name = basename(relative(opts.src, f), '.js')\n          log(name)\n          return `${pkg.name}/${opts.lib}/${name}`\n        })\n      )\n    }, [])\n\n    const optimizedModules = resolve(pkgRoot, 'optimized-modules.json')\n    put(optimizedModules, JSON.stringify(modules, null, 2), 'utf8')\n  }\n})\n\nfunction setOptimization(level) {\n  return Math.max(level | 0, 0)\n}\n\nfunction formatCCArgs(flag) {\n  return Object.keys(flag).map(name => {\n    let pre = /^-|--/.test(name)? '' : '--'\n      , val = `=${flag[name]}`\n\n    if (typeof flag[name] === 'boolean') {\n      flag[name]? (val = '') : (pre = `${pre}no-`)\n    }\n\n    return `${pre}${name}${val}`\n  }).join(' ')\n}\n\nfunction log(...args) {\n  if (process.env.DEBUG) {\n    console.error.call(console, '#', ...args)\n  }\n}\n\nfunction getTarget(opts) {\n  const levels = \n    [ `--out-dir ${opts.lib}`\n    , `--out-file ${opts.out}`\n    ]\n\n  return levels[opts.optimize] || levels[0]\n}\n\nfunction setFlag(map, input) {\n  if (typeof input === 'string') {\n    const [k, v]  = input.split('=')\n        , aliased = v.split(',').aliasFlag\n\n    if (k.slice(-1) === '+') {\n      map[k] = [].concat(map[k], aliased).filter(v => v !== undefined)\n    } else {\n      map[k] = aliased\n    }\n  } else {\n    Object.keys(input).forEach(k => map[k] = input[k])\n  }\n\n  return map\n}\n\nfunction aliasFlag(val) {\n  return aliases[val] || val\n}\n\nconst aliases =\n  { true: true\n  , false: false\n  , undefined: true\n  }\n\nfunction addPath(paths, val) {\n  return [val].concat(paths)\n}\n"]}